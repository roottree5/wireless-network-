# 스마트 도어락 시스템 프로젝트_서준원

## 서준원 역할 및 작업 내용
---
## 작업내용
### **센서 데이터 실시간 MySQL 업로드**

**목표**:  
센서 데이터를 **Arduino**를 사용해 실시간으로 **MySQL 데이터베이스**에 업로드했습니다.

**과정**:  
- 센서 데이터는 Arduino에서 수집되며, 이를 실시간으로 MySQL 서버에 전송하는 로직을 구현했습니다.
- 데이터 업로드 방식:
  - 센서 데이터 처리 코드에서 이벤트가 발생 시, 읽어온 데이터를 MySQL에 저장할 수 있도록 Arduino 코드를 작성했습니다.
  - 데이터 전송 시, **센서 데이터의 타임스탬프**를 함께 저장했습니다.

**구현 세부사항**:  
1. **데이터 업로드 코드**:  
   - Arduino에서 센서 데이터를 읽어온 후, MySQL로 데이터를 삽입하는 SQL 쿼리를 구성했습니다.  
     ```cpp
     String query = "INSERT INTO event_manage (fingerp_confirm_time, door_status)
           VALUES (NOW(), " + String(door_status) + ")"; //지문으로 인한 문열림 발생시간(현시간)을 timestamp형태로 추가합니다
     MySQL_Cursor *cur_mem = new MySQL_Cursor(&conn);
     cur_mem->execute(query.c_str());
     delete cur_mem;
     ```
   - 데이터 전송 과정에서 센서에서 처리된 정보를 MySQL 테이블에 저장했습니다.

2. **에러 핸들링**:  
   - 데이터 전송 중 MySQL 연결이 끊어지는 경우를 대비해, 연결 상태를 주기적으로 확인하고, 연결이 끊어지면 자동으로 다시 연결하는 로직을 추가했습니다.
   - 업로드 실패 시, 데이터를 버퍼에 저장한 뒤, 연결이 복구되면 다시 전송하는 방식으로 데이터 유실을 방지했습니다.



**결과**:  
- Arduino와 MySQL 서버 간의 실시간 데이터 업로드가 성공적으로 구현되었습니다.
- 센서 데이터를 실시간으로 저장할 수 있는 시스템을 구축했으며, 이를 기반으로 데이터 분석 및 시각화가 가능해졌습니다.

---
## 문제 해결

### **1. MySQL 라이브러리 문제 해결**

**목표**:  
센서 데이터를 MySQL로 업로드하는 과정에서 발생한 **MySQL 라이브러리**와 관련된 여러 문제를 해결했습니다.

**과정**:  
Arduino에서 사용하는 **MySQL_Connection** 및 **MySQL_Cursor** 라이브러리와 MySQL 서버 간의 호환성 문제가 발생했습니다. 이를 해결하기 위해 데이터베이스 버전 조정 및 라이브러리 함수 수정 작업을 진행했습니다.

**오류 및 해결 과정**:

1. **MySQL 데이터베이스 버전 호환성 문제**:  
   - MySQL 서버와 Arduino 간의 연결 시, **쿼리 실행 결과**가 제대로 반환되지 않는 문제를 발견했습니다.
   - MySQL 버전의 호환성 문제로 인해 **MySQL 데이터베이스 버전 8.4.3으로 다운그레이드**하여 문제를 해결했습니다.

2. **함수 반환 값 처리 문제**:  
   - **MySQL 라이브러리 함수** 중 일부가 `void`가 아닌 함수임에도 불구하고 반환 값을 처리하지 않아 오류가 발생했습니다.  
   - **`execute()`** 함수에서 실행 결과를 반환하도록 코드 수정 작업을 진행했습니다.  
     수정 전:
     ```cpp
     bool execute(String query) {
         // 코드 일부
     }
     ```
     수정 후:
     ```cpp
     bool execute(String query) {
         // 실행 결과 반환
         return success; 
     }
     ```

**결과**:  
- 데이터베이스 버전을 **8.4.3**으로 조정하고, 라이브러리 코드를 수정하여 센서 데이터를 안정적으로 업로드했습니다.

### 2. **MySQL 설정 수정**

**목표**:  
Arduino에서 MySQL 서버에 데이터를 업로드할 때 **MySQL 비밀번호 설정**을 조정하여 연결 문제를 해결하는 작업을 진행했습니다.

**과정**:  
MySQL의 기본 비밀번호 인증 방식인 **`caching_sha2_password`**를 사용했으나, Arduino에서는 이를 처리할 수 없어 연결이 실패하는 문제가 발생했습니다. 이를 해결하기 위해 **`mysql_native_password`** 방식으로 인증 방식을 변경하였고, 그 과정에서 몇 가지 설정을 수정했습니다.

**해결 과정**:

1. **`caching_sha2_password`에서 `mysql_native_password`로 인증 방식 변경**:
   - MySQL 8.0 이상에서 기본적으로 **`caching_sha2_password`**가 사용됩니다. 이는 보안성이 높지만, Arduino 라이브러리와 호환되지 않아 연결에 문제가 발생했습니다.
   - 이를 해결하기 위해 **`mysql_native_password`**로 인증 방식을 변경하였습니다. `mysql_native_password`는 더 오래된 인증 방식으로, 많은 MySQL 클라이언트가 이를 지원하므로 Arduino와의 호환성 문제를 해결할 수 있었습니다.

2. **인증 방식 변경 방법**:
   - MySQL에서 사용되는 비밀번호 인증 방식을 변경하려면, **MySQL 사용자 계정의 인증 플러그인**을 수정해야 합니다.
   
   **구체적인 변경 과정**:
   1. MySQL에 접속합니다:
      ```bash
      mysql -u root -p
      ```
   2. 인증 방식을 변경할 사용자 계정을 선택하여 **`mysql_native_password`** 플러그인을 설정합니다:
      ```sql
      ALTER USER 'arduino_user'@'%' IDENTIFIED WITH mysql_native_password BY 'your_password';
      ```
      - 여기서 `arduino_user`는 MySQL에서 사용 중인 사용자 이름이고, `your_password`는 해당 사용자의 비밀번호입니다.
      - `'%'`는 모든 IP에서의 접속을 허용하는 것입니다. 특정 IP에서만 접속을 허용하려면 `%` 대신 해당 IP 주소를 사용할 수 있습니다.
   3. 변경된 설정을 적용하기 위해 MySQL 서버를 재시작했습니다.
      ```bash
      sudo systemctl restart mysql
      ```

3. **MySQL 사용자 권한 재부여**:
   - 인증 방식 변경 후, 사용자 권한을 다시 확인하고 재부여했습니다. 
      ```sql
      FLUSH PRIVILEGES;
      ```
   
4. **문서 수정**:
   - MySQL의 인증 방식 변경과 관련된 설정을 확인하기 위해 **MySQL 설정 파일**`/etc/my.cnf`을 수정했습니다.
     - **기본 인증 플러그인**을 변경하기 위해서, MySQL 설정 파일에서 `default_authentication_plugin` 항목을 수정했습니다.
       ```ini
       [mysqld]
       default_authentication_plugin=mysql_native_password
       ```
     - 변경 후 MySQL 서버를 재시작하여 설정을 반영했습니다.
       ```bash
       sudo systemctl restart mysql
       ```

**결과**:  
**`caching_sha2_password`**에서 **`mysql_native_password`**로 인증 방식을 변경한 후, Arduino와 MySQL 간의 연결 문제를 해결할 수 있었습니다. 이 변경으로 Arduino가 MySQL 서버에 정상적으로 연결되고, 데이터를 업로드하는 데 성공했습니다.

---
### 3. **외부 IP 접속 허용 및 공유기 호스팅**

**목표**:  
MySQL 서버에 원격으로 접속할 수 있도록 네트워크 설정을 수정하여, 외부에서 MySQL 서버에 접근할 수 있도록 허용하는 작업을 진행했습니다.

**과정**:  
외부에서 MySQL 서버에 접근하려면 공유기에서 포트 포워딩을 설정하고, MySQL 서버와 관련된 네트워크 및 방화벽 설정을 점검해야 했습니다. 이를 통해 외부 IP에서 MySQL 서버에 원활하게 연결할 수 있도록 만들었습니다.

#### 1. **공유기에서 포트 포워딩 설정**
   - **목표**: 외부 네트워크에서 MySQL 서버에 접속할 수 있도록 공유기에서 포트 포워딩 설정을 진행했습니다.
   - **과정**:  
     - 기본적으로 MySQL은 3306번 포트를 사용하여 통신합니다. 외부에서 이 포트로 접근할 수 있도록 공유기에서 포트 포워딩을 설정했습니다.
     - 공유기의 관리 페이지에 접속하여 포트 포워딩 설정을 추가했습니다.
       1. **공유기 관리 페이지 접속**: 웹 브라우저에서 공유기의 IP 주소 `192.168.0.1`를 입력하여 로그인합니다.
       2. **포트 포워딩 설정**: 관리 페이지에서 "포트 포워딩" 항목을 찾습니다. 그곳에서 3306번 포트를 지정하여 MySQL 서버로 전달되도록 설정합니다.
          - 예를 들어:
            - **외부 포트**: 3306
            - **내부 포트**: 3306
            - **내부 IP 주소**: MySQL 서버가 설치된 컴퓨터의 IP 주소 (192.168.1.100)

#### 2. **MySQL 서버 외부 접속 허용**
   - **목표**: MySQL 서버에서 외부 IP의 접속을 허용하도록 MySQL 설정을 변경했습니다.
   - **과정**:
     - 기본적으로 MySQL은 **로컬 접속만 허용**합니다. 외부에서 접속할 수 있도록 MySQL의 설정 파일을 수정해야 했습니다.
     - MySQL의 설정 파일 `my.cnf`에서 **bind-address**를 수정하여 외부 IP에서 접속할 수 있도록 했습니다.

     **bind-address 수정**
        - `bind-address` 항목을 `0.0.0.0`으로 변경하여 모든 IP에서 MySQL 서버에 접속할 수 있도록 했습니다.
          ```ini
          bind-address = 0.0.0.0
          ```
        - **0.0.0.0**은 모든 네트워크 인터페이스에서 접속을 허용하는 의미입니다. 특정 IP에서만 접속을 허용하려면 해당 IP 주소를 넣으면 됩니다.

#### 3. **외부 IP에서 접속 테스트**
   - 설정이 모두 완료된 후, 외부 네트워크에서 MySQL에 접속할 수 있는지 테스트했습니다.
   - **MySQL Workbench** 를 통해 접속을 시도했습니다:
     ```bash
     mysql -u username -p -h [공인 IP 주소] -P 3306
     ```
     - 이때, `username`은 MySQL 사용자 계정이고, `[공인 IP 주소]`는 MySQL 서버가 호스팅된 서버의 공인 IP 주소입니다.


**결과**:  
포트 포워딩과 MySQL 설정을 통해 MySQL 서버가 외부에서 접속할 수 있도록 성공적으로 설정을 완료했습니다. 이를 통해 Arduino와 같은 원격 장치가 MySQL 서버에 데이터를 업로드할 수 있게 되었으며, 서버 접근이 원활하게 이루어졌습니다.

---


### **4. Arduino와 센서 호환성 문제 해결**

**목표**:  
프로젝트에서 사용된 **지문 인식 센서**와 보드 간의 호환성 문제를 해결했습니다.

**과정**:  
- **초기 문제**:  
  - 아두이노 부족으로 인하여 **Arduino Uno**를 사용하여 작성된 코드를 기반으로 진행했으나, **Wemos D1 R1** 보드에 연결했을 때 **지문 센서**가 제대로 동작하지 않는 문제가 발생했습니다.
  - 하지만, **지문 인식 센서**가 Wemos D1 R1 보드에서 제대로 작동하지 않는 문제가 발생했습니다.  

- **문제 해결을 위한 시도**:  
  - Wemos D1 R1 보드의 핀 번호를 여러 조합으로 변경하면서 테스트했습니다.  
  - 보드와 센서 간의 통신 프로토콜(UART) 문제를 의심하며, **보드 설정**과 **통신 속도(baud rate)**를 다양하게 조정하며 디버깅을 진행했습니다.  
  - 컴파일 과정에서 보드 설정을 **ESP8266 Wemos D1 R1** 외에 다른 보드로 변경하여 테스트를 시도했습니다.  

- **최종 해결**:  
  - 여러 설정을 시도했으나 Wemos D1 R1 보드에서는 지문 센서와의 호환성 문제를 완전히 해결할 수 없었습니다.  
  - 보드를 **Wemos D1 R2**로 교체한 후, 필요한 하드웨어 설정을 다시 조정하고 핀 번호를 재구성했습니다.  
  - 또한, 센서의 데이터 통신을 확인하기 위해, 시리얼 포트 설정도 반복적으로 테스트하며 최적의 설정을 찾았습니다.  

**결과 및 성과**:  
- Wemos D1 R2 보드로 교체하면서 지문 인식 센서와의 호환성 문제가 완전히 해결되었습니다.  
- 모든 센서가 정상적으로 작동하도록 설정을 완료했습니다.

---

### **5. 문 제어 로직 개선**  
- **목표**: 문이 열리고 닫히는 과정에서 발생하는 문제를 해결하고, 상태 변화나 사용자 등록 이벤트가 즉시 데이터베이스에 반영되도록 개선 작업을 진행했습니다.

- **과정**:  
  - **자동 문 닫힘 문제 해결**:  
    - 기존 로직에서는 문이 열린 뒤 일정 시간이 지나도 닫히지 않는 문제가 발생했습니다.  
    - 이를 해결하기 위해, **시간 기반 조건 로직**을 추가하여 문이 열린 후 일정 시간이 지나면 자동으로 닫히도록 구현했습니다.  
    - `millis()` 함수를 사용해 현재 시간을 확인하고, 이전 이벤트 시간이 일정 간격 이상 경과했는지 확인하는 로직을 적용했습니다.  

  - **Delay 대신 `millis()` 사용 이유**:  
    - `delay()` 함수는 호출되는 동안 코드 실행을 중단시키기 때문에, MQTT통신을 계속 대기해야하는 저희 시스템에서는 비효율적입니다.  
    - 반면 `millis()` 함수는 비차단(non-blocking) 방식으로 작동하여, 시간 경과를 감지하는 동안에도 다른 작업을 계속 수행할 수 있습니다.  
    - 이 방식을 통해 센서 입력, 사용자 명령, 데이터베이스 업데이트 등 다양한 작업을 동시에 처리할 수 있었습니다.  

- **결과**:  
  - 문이 열린 뒤 닫히지 않는 문제를 해결하여 문 제어 시스템의 안정성을 확보했습니다.  
  - `millis()` 기반 로직을 사용함으로써 비차단 방식의 효율적인 코드 구조를 구현했습니다.  
  - 주요 이벤트가 발생할 때 데이터베이스가 실시간으로 업데이트되도록 구현했습니다.


## 향후 개선 사항
### **향후 개선 사항**

- **데이터베이스 보안 강화**:  
  현재 센서 데이터를 MySQL로 전송할 때, **쿼리가 암호화되지 않은 상태로 전송**되고 있어 **보안 취약점**이 존재합니다.  
  이는 네트워크 상에서 데이터가 노출될 위험이 있으므로, 데이터베이스와의 통신에 **SSL(암호화된 연결)** 을 적용할 계획입니다.  
  - **문제점**: 현재 방식에서는 데이터와 쿼리가 평문으로 전송되기 때문에, 중간자 공격(Man-In-The-Middle Attack)에 노출될 수 있습니다.
  - **해결 방안**:
    1. **SSL 인증서**를 생성 및 설치하여 MySQL 서버와 Arduino 간 통신을 암호화합니다.
    2. **라이브러리 지원 여부 확인**: Arduino에서 사용하는 MySQL 라이브러리가 SSL 지원을 제공하는지 확인하고, 필요한 경우 SSL 설정이 가능한 라이브러리로 전환합니다.
    3. 데이터 전송 시 쿼리를 암호화하여 전송하거나, 데이터를 전송하기 전 **해시(hash)** 또는 **AES(Advanced Encryption Standard)** 같은 암호화 알고리즘을 적용하는 방식을 검토합니다.

- **센서 데이터 처리 최적화**: 센서에서 수집된 데이터를 처리하는 방식에 대한 최적화를 더 진행하여, 대규모 데이터 처리가 가능한 시스템을 구축하고 싶습니다.
